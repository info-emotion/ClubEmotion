
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StockMaster AI - Gestione Magazzino</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel Standalone per la compilazione in-browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom": "https://esm.sh/react-dom@^19.2.3",
    "react-dom/client": "https://esm.sh/react-dom@^19.2.3/client",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "recharts": "https://esm.sh/recharts@^3.6.0",
    "html5-qrcode": "https://esm.sh/html5-qrcode@^2.3.8",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        #loader-container { transition: opacity 0.5s ease; }
        .loaded #loader-container { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <div id="loader-container" class="fixed inset-0 flex items-center justify-center bg-white z-[9999]">
        <div class="flex flex-col items-center gap-4 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-emerald-500"></div>
            <div>
                <p id="status-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">Inizializzazione Core...</p>
                <p id="error-text" class="hidden text-xs text-red-500 mt-2 font-medium px-4"></p>
            </div>
        </div>
    </div>

    <script type="module">
        // Configurazione Babel
        Babel.registerPreset("env", {
            targets: { browsers: ["last 2 versions"] }
        });

        const statusEl = document.getElementById('status-text');
        const errorEl = document.getElementById('error-text');

        async function loadAndExecute(url) {
            try {
                statusEl.textContent = `Caricamento ${url.split('/').pop()}...`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Errore HTTP ${response.status} per ${url}`);
                const code = await response.text();
                
                statusEl.textContent = `Compilazione ${url.split('/').pop()}...`;
                const transpiled = Babel.transform(code, {
                    presets: ["react", "typescript"],
                    filename: url,
                    plugins: [
                        // Trasforma gli import .tsx per essere compatibili con il loader
                        ({ types: t }) => ({
                            visitor: {
                                ImportDeclaration(path) {
                                    if (path.node.source.value.startsWith('./') || path.node.source.value.startsWith('../')) {
                                        // Manteniamo i percorsi relativi
                                    }
                                }
                            }
                        })
                    ]
                }).code;

                // Creazione di un blob per eseguire il codice come modulo
                const blob = new Blob([transpiled], { type: 'application/javascript' });
                const blobUrl = URL.createObjectURL(blob);
                return blobUrl;
            } catch (err) {
                console.error(`Errore caricamento ${url}:`, err);
                errorEl.textContent = `Errore critico: ${err.message}`;
                errorEl.classList.remove('hidden');
                statusEl.classList.add('hidden');
                throw err;
            }
        }

        // Sistema di caricamento per l'avvio di React
        (async () => {
            try {
                // Poiché non possiamo risolvere facilmente gli import ricorsivi tra file locali con Babel Standalone 
                // in modo nativo e veloce, usiamo questo trucco: carichiamo il file principale e Babel 
                // farà il resto se configurato correttamente. 
                // Tuttavia, la soluzione più robusta senza build è usare script type="text/tsx" 
                // che Babel Standalone processa automaticamente cercandoli nel DOM.
                
                // INIETTIAMO IL BOOTSTRAP DIRETTAMENTE
                const bootstrapScript = document.createElement('script');
                bootstrapScript.type = 'text/tsx';
                bootstrapScript.dataset.presets = "react,typescript";
                
                // Carichiamo index.tsx come testo e lo mettiamo nel tag
                const response = await fetch('./index.tsx');
                bootstrapScript.textContent = await response.text();
                document.body.appendChild(bootstrapScript);

                // Babel Standalone processerà automaticamente il tag aggiunto
                // Monitoriamo il caricamento di React
                const checkReact = setInterval(() => {
                    if (document.querySelector('#root > div')) {
                        document.body.classList.add('loaded');
                        clearInterval(checkReact);
                    }
                }, 100);

            } catch (err) {
                console.error("Bootstrap failed:", err);
            }
        })();
    </script>
</body>
</html>
